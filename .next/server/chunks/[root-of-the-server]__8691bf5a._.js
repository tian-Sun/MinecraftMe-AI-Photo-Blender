module.exports = {

"[project]/.next-internal/server/app/api/remaining/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/punycode [external] (punycode, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[project]/src/lib/supabase.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "createOrUpdateUserSubscription": (()=>createOrUpdateUserSubscription),
    "createUserUsage": (()=>createUserUsage),
    "getUserSubscription": (()=>getUserSubscription),
    "getUserUsage": (()=>getUserUsage),
    "isSupabaseConfigured": (()=>isSupabaseConfigured),
    "supabase": (()=>supabase),
    "updateUserUsage": (()=>updateUserUsage)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
;
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const isSupabaseConfigured = supabaseUrl && supabaseAnonKey;
const supabase = isSupabaseConfigured ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(supabaseUrl, supabaseAnonKey) : null;
// 内存存储回退（当 Supabase 未配置时使用）
const memoryStorage = {};
async function getUserUsage(userEmail, date) {
    if (!isSupabaseConfigured) {
        // 使用内存存储
        const key = `${userEmail}_${date}`;
        if (!memoryStorage[key] || memoryStorage[key].date !== date) {
            memoryStorage[key] = {
                count: 0,
                date
            };
        }
        return {
            user_email: userEmail,
            usage_count: memoryStorage[key].count,
            usage_date: date
        };
    }
    const { data, error } = await supabase.from('user_usage').select('*').eq('user_email', userEmail).eq('usage_date', date).single();
    if (error && error.code !== 'PGRST116') {
        console.error('Error fetching user usage:', error);
        return null;
    }
    return data;
}
async function createUserUsage(userEmail, date) {
    if (!isSupabaseConfigured) {
        // 使用内存存储
        const key = `${userEmail}_${date}`;
        memoryStorage[key] = {
            count: 0,
            date
        };
        return {
            user_email: userEmail,
            usage_count: 0,
            usage_date: date
        };
    }
    const { data, error } = await supabase.from('user_usage').insert([
        {
            user_email: userEmail,
            usage_count: 0,
            usage_date: date
        }
    ]).select().single();
    if (error) {
        console.error('Error creating user usage:', error);
        return null;
    }
    return data;
}
async function updateUserUsage(userEmail, date, newCount) {
    if (!isSupabaseConfigured) {
        // 使用内存存储
        const key = `${userEmail}_${date}`;
        if (memoryStorage[key]) {
            memoryStorage[key].count = newCount;
        }
        return true;
    }
    const { error } = await supabase.from('user_usage').update({
        usage_count: newCount,
        updated_at: new Date().toISOString()
    }).eq('user_email', userEmail).eq('usage_date', date);
    if (error) {
        console.error('Error updating user usage:', error);
        return false;
    }
    return true;
}
async function getUserSubscription(userEmail) {
    if (!isSupabaseConfigured) {
        // 开发环境默认给Premium订阅
        return {
            user_email: userEmail,
            plan_id: 'premium',
            credits: 100,
            status: 'active'
        };
    }
    const { data, error } = await supabase.from('user_subscriptions').select('*').eq('user_email', userEmail).eq('status', 'active').single();
    if (error && error.code !== 'PGRST116') {
        console.error('Error fetching user subscription:', error);
        return null;
    }
    return data;
}
async function createOrUpdateUserSubscription(params) {
    const { email, planId, credits, orderId } = params;
    if (!isSupabaseConfigured) {
        console.log('✅ Supabase not configured, subscription created in memory');
        return {
            success: true
        };
    }
    try {
        // 首先检查是否已有活跃订阅
        const existingSubscription = await getUserSubscription(email);
        if (existingSubscription) {
            // 更新现有订阅的积分
            const { error } = await supabase.from('user_subscriptions').update({
                credits: existingSubscription.credits + credits,
                updated_at: new Date().toISOString()
            }).eq('user_email', email).eq('status', 'active');
            if (error) {
                console.error('Error updating subscription:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        } else {
            // 创建新订阅
            const { error } = await supabase.from('user_subscriptions').insert([
                {
                    user_email: email,
                    plan_id: planId,
                    credits: credits,
                    status: 'active',
                    order_id: orderId
                }
            ]);
            if (error) {
                console.error('Error creating subscription:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        return {
            success: true
        };
    } catch (error) {
        console.error('Unexpected error in createOrUpdateUserSubscription:', error);
        return {
            success: false,
            error: 'Unexpected error occurred'
        };
    }
}
}}),
"[project]/src/app/api/remaining/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/next/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/supabase.ts [app-route] (ecmascript)");
;
;
;
const DAILY_USAGE_LIMIT = 1;
function getTodayKey() {
    return new Date().toISOString().split('T')[0];
}
function getTimeLeft() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    const diff = tomorrow.getTime() - now.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor(diff % (1000 * 60 * 60) / (1000 * 60));
    return {
        hours,
        minutes
    };
}
async function GET(request) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])();
        if (!session?.user?.email) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const userEmail = session.user.email;
        const todayKey = getTodayKey();
        // 检查用户是否有付费订阅
        const subscription = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getUserSubscription"])(userEmail);
        if (subscription && subscription.credits > 0) {
            // 付费用户：返回剩余积分
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                remainingGenerations: subscription.credits,
                isPaidUser: true,
                planId: subscription.plan_id,
                dailyLimit: subscription.credits
            });
        } else {
            // 免费用户：使用每日限制
            let userUsage = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getUserUsage"])(userEmail, todayKey);
            if (!userUsage) {
                userUsage = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createUserUsage"])(userEmail, todayKey);
                if (!userUsage) {
                    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                        error: 'Failed to create user usage record'
                    }, {
                        status: 500
                    });
                }
            }
            const remainingGenerations = Math.max(0, DAILY_USAGE_LIMIT - userUsage.usage_count);
            const timeLeft = getTimeLeft();
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                remainingGenerations,
                isPaidUser: false,
                hours: timeLeft.hours,
                minutes: timeLeft.minutes,
                dailyLimit: DAILY_USAGE_LIMIT
            });
        }
    } catch (error) {
        console.error('GET /api/remaining error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
async function POST(request) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])();
        if (!session?.user?.email) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const userEmail = session.user.email;
        const todayKey = getTodayKey();
        // 检查用户是否有付费订阅
        const subscription = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getUserSubscription"])(userEmail);
        if (subscription && subscription.credits > 0) {
            // 付费用户：扣除积分
            const newCredits = subscription.credits - 1;
            // 这里需要添加更新subscription credits的函数
            // 暂时返回成功，在实际应用中需要更新数据库
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: true,
                remainingGenerations: newCredits,
                isPaidUser: true
            });
        } else {
            // 免费用户：使用每日限制
            let userUsage = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getUserUsage"])(userEmail, todayKey);
            if (!userUsage) {
                userUsage = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createUserUsage"])(userEmail, todayKey);
                if (!userUsage) {
                    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                        error: 'Failed to create user usage record'
                    }, {
                        status: 500
                    });
                }
            }
            // 检查是否还有剩余次数
            if (userUsage.usage_count >= DAILY_USAGE_LIMIT) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Daily limit exceeded'
                }, {
                    status: 429
                });
            }
            // 增加使用次数
            const newCount = userUsage.usage_count + 1;
            const success = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["updateUserUsage"])(userEmail, todayKey, newCount);
            if (!success) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Failed to update usage count'
                }, {
                    status: 500
                });
            }
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: true,
                remainingGenerations: Math.max(0, DAILY_USAGE_LIMIT - newCount),
                isPaidUser: false
            });
        }
    } catch (error) {
        console.error('POST /api/remaining error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__8691bf5a._.js.map
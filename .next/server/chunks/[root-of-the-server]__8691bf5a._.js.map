{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///Users/xyw/Tian/Real_PM/MinecraftMe-AI-Photo-Blender/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n// 检查 Supabase 是否配置\nexport const isSupabaseConfigured = supabaseUrl && supabaseAnonKey;\n\nexport const supabase = isSupabaseConfigured \n  ? createClient(supabaseUrl!, supabaseAnonKey!)\n  : null;\n\n// 内存存储回退（当 Supabase 未配置时使用）\nconst memoryStorage: Record<string, { count: number; date: string }> = {};\n\n// 数据库表接口\nexport interface UserUsage {\n  id?: number;\n  user_email: string;\n  usage_count: number;\n  usage_date: string;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface UserSubscription {\n  id?: number;\n  user_email: string;\n  plan_id: string;\n  credits: number;\n  status: 'active' | 'expired' | 'cancelled';\n  order_id?: string;\n  created_at?: string;\n  updated_at?: string;\n}\n\n// 获取或创建用户使用记录\nexport async function getUserUsage(userEmail: string, date: string): Promise<UserUsage | null> {\n  if (!isSupabaseConfigured) {\n    // 使用内存存储\n    const key = `${userEmail}_${date}`;\n    if (!memoryStorage[key] || memoryStorage[key].date !== date) {\n      memoryStorage[key] = { count: 0, date };\n    }\n    return {\n      user_email: userEmail,\n      usage_count: memoryStorage[key].count,\n      usage_date: date,\n    };\n  }\n\n  const { data, error } = await supabase!\n    .from('user_usage')\n    .select('*')\n    .eq('user_email', userEmail)\n    .eq('usage_date', date)\n    .single();\n\n  if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found\n    console.error('Error fetching user usage:', error);\n    return null;\n  }\n\n  return data;\n}\n\n// 创建用户使用记录\nexport async function createUserUsage(userEmail: string, date: string): Promise<UserUsage | null> {\n  if (!isSupabaseConfigured) {\n    // 使用内存存储\n    const key = `${userEmail}_${date}`;\n    memoryStorage[key] = { count: 0, date };\n    return {\n      user_email: userEmail,\n      usage_count: 0,\n      usage_date: date,\n    };\n  }\n\n  const { data, error } = await supabase!\n    .from('user_usage')\n    .insert([\n      {\n        user_email: userEmail,\n        usage_count: 0,\n        usage_date: date,\n      }\n    ])\n    .select()\n    .single();\n\n  if (error) {\n    console.error('Error creating user usage:', error);\n    return null;\n  }\n\n  return data;\n}\n\n// 更新用户使用次数\nexport async function updateUserUsage(userEmail: string, date: string, newCount: number): Promise<boolean> {\n  if (!isSupabaseConfigured) {\n    // 使用内存存储\n    const key = `${userEmail}_${date}`;\n    if (memoryStorage[key]) {\n      memoryStorage[key].count = newCount;\n    }\n    return true;\n  }\n\n  const { error } = await supabase!\n    .from('user_usage')\n    .update({ usage_count: newCount, updated_at: new Date().toISOString() })\n    .eq('user_email', userEmail)\n    .eq('usage_date', date);\n\n  if (error) {\n    console.error('Error updating user usage:', error);\n    return false;\n  }\n\n  return true;\n}\n\n// 获取用户订阅信息\nexport async function getUserSubscription(userEmail: string): Promise<UserSubscription | null> {\n  if (!isSupabaseConfigured) {\n    // 开发环境默认给Premium订阅\n    return {\n      user_email: userEmail,\n      plan_id: 'premium',\n      credits: 100,\n      status: 'active'\n    };\n  }\n\n  const { data, error } = await supabase!\n    .from('user_subscriptions')\n    .select('*')\n    .eq('user_email', userEmail)\n    .eq('status', 'active')\n    .single();\n\n  if (error && error.code !== 'PGRST116') {\n    console.error('Error fetching user subscription:', error);\n    return null;\n  }\n\n  return data;\n}\n\n// 创建或更新用户订阅\nexport async function createOrUpdateUserSubscription(params: {\n  email: string;\n  planId: string;\n  credits: number;\n  orderId?: string;\n}): Promise<{ success: boolean; error?: string }> {\n  const { email, planId, credits, orderId } = params;\n\n  if (!isSupabaseConfigured) {\n    console.log('✅ Supabase not configured, subscription created in memory');\n    return { success: true };\n  }\n\n  try {\n    // 首先检查是否已有活跃订阅\n    const existingSubscription = await getUserSubscription(email);\n    \n    if (existingSubscription) {\n      // 更新现有订阅的积分\n      const { error } = await supabase!\n        .from('user_subscriptions')\n        .update({\n          credits: existingSubscription.credits + credits,\n          updated_at: new Date().toISOString()\n        })\n        .eq('user_email', email)\n        .eq('status', 'active');\n\n      if (error) {\n        console.error('Error updating subscription:', error);\n        return { success: false, error: error.message };\n      }\n    } else {\n      // 创建新订阅\n      const { error } = await supabase!\n        .from('user_subscriptions')\n        .insert([{\n          user_email: email,\n          plan_id: planId,\n          credits: credits,\n          status: 'active',\n          order_id: orderId\n        }]);\n\n      if (error) {\n        console.error('Error creating subscription:', error);\n        return { success: false, error: error.message };\n      }\n    }\n\n    return { success: true };\n  } catch (error) {\n    console.error('Unexpected error in createOrUpdateUserSubscription:', error);\n    return { success: false, error: 'Unexpected error occurred' };\n  }\n} "],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 335, "column": 0}, "map": {"version":3,"sources":["file:///Users/xyw/Tian/Real_PM/MinecraftMe-AI-Photo-Blender/src/app/api/remaining/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth/next';\nimport { getUserUsage, createUserUsage, updateUserUsage, getUserSubscription } from '@/lib/supabase';\n\nconst DAILY_USAGE_LIMIT = 1;\n\nfunction getTodayKey(): string {\n  return new Date().toISOString().split('T')[0];\n}\n\nfunction getTimeLeft() {\n  const now = new Date();\n  const tomorrow = new Date(now);\n  tomorrow.setDate(tomorrow.getDate() + 1);\n  tomorrow.setHours(0, 0, 0, 0);\n  const diff = tomorrow.getTime() - now.getTime();\n  const hours = Math.floor(diff / (1000 * 60 * 60));\n  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n  return { hours, minutes };\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getServerSession();\n    \n    if (!session?.user?.email) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const userEmail = session.user.email;\n    const todayKey = getTodayKey();\n    \n    // 检查用户是否有付费订阅\n    const subscription = await getUserSubscription(userEmail);\n    \n    if (subscription && subscription.credits > 0) {\n      // 付费用户：返回剩余积分\n      return NextResponse.json({\n        remainingGenerations: subscription.credits,\n        isPaidUser: true,\n        planId: subscription.plan_id,\n        dailyLimit: subscription.credits,\n      });\n    } else {\n      // 免费用户：使用每日限制\n      let userUsage = await getUserUsage(userEmail, todayKey);\n      \n      if (!userUsage) {\n        userUsage = await createUserUsage(userEmail, todayKey);\n        if (!userUsage) {\n          return NextResponse.json({ error: 'Failed to create user usage record' }, { status: 500 });\n        }\n      }\n\n      const remainingGenerations = Math.max(0, DAILY_USAGE_LIMIT - userUsage.usage_count);\n      const timeLeft = getTimeLeft();\n\n      return NextResponse.json({\n        remainingGenerations,\n        isPaidUser: false,\n        hours: timeLeft.hours,\n        minutes: timeLeft.minutes,\n        dailyLimit: DAILY_USAGE_LIMIT,\n      });\n    }\n  } catch (error) {\n    console.error('GET /api/remaining error:', error);\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getServerSession();\n    \n    if (!session?.user?.email) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const userEmail = session.user.email;\n    const todayKey = getTodayKey();\n    \n    // 检查用户是否有付费订阅\n    const subscription = await getUserSubscription(userEmail);\n    \n    if (subscription && subscription.credits > 0) {\n      // 付费用户：扣除积分\n      const newCredits = subscription.credits - 1;\n      \n      // 这里需要添加更新subscription credits的函数\n      // 暂时返回成功，在实际应用中需要更新数据库\n      return NextResponse.json({ \n        success: true, \n        remainingGenerations: newCredits,\n        isPaidUser: true\n      });\n    } else {\n      // 免费用户：使用每日限制\n      let userUsage = await getUserUsage(userEmail, todayKey);\n      \n      if (!userUsage) {\n        userUsage = await createUserUsage(userEmail, todayKey);\n        if (!userUsage) {\n          return NextResponse.json({ error: 'Failed to create user usage record' }, { status: 500 });\n        }\n      }\n\n      // 检查是否还有剩余次数\n      if (userUsage.usage_count >= DAILY_USAGE_LIMIT) {\n        return NextResponse.json({ error: 'Daily limit exceeded' }, { status: 429 });\n      }\n\n      // 增加使用次数\n      const newCount = userUsage.usage_count + 1;\n      const success = await updateUserUsage(userEmail, todayKey, newCount);\n      \n      if (!success) {\n        return NextResponse.json({ error: 'Failed to update usage count' }, { status: 500 });\n      }\n\n      return NextResponse.json({ \n        success: true, \n        remainingGenerations: Math.max(0, DAILY_USAGE_LIMIT - newCount),\n        isPaidUser: false\n      });\n    }\n  } catch (error) {\n    console.error('POST /api/remaining error:', error);\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n} "],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,oBAAoB;AAE1B,SAAS;IACP,OAAO,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;AAC/C;AAEA,SAAS;IACP,MAAM,MAAM,IAAI;IAChB,MAAM,WAAW,IAAI,KAAK;IAC1B,SAAS,OAAO,CAAC,SAAS,OAAO,KAAK;IACtC,SAAS,QAAQ,CAAC,GAAG,GAAG,GAAG;IAC3B,MAAM,OAAO,SAAS,OAAO,KAAK,IAAI,OAAO;IAC7C,MAAM,QAAQ,KAAK,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,EAAE;IAC/C,MAAM,UAAU,KAAK,KAAK,CAAC,AAAC,OAAO,CAAC,OAAO,KAAK,EAAE,IAAK,CAAC,OAAO,EAAE;IACjE,OAAO;QAAE;QAAO;IAAQ;AAC1B;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,UAAU,MAAM,CAAA,GAAA,+IAAA,CAAA,mBAAgB,AAAD;QAErC,IAAI,CAAC,SAAS,MAAM,OAAO;YACzB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,YAAY,QAAQ,IAAI,CAAC,KAAK;QACpC,MAAM,WAAW;QAEjB,cAAc;QACd,MAAM,eAAe,MAAM,CAAA,GAAA,wHAAA,CAAA,sBAAmB,AAAD,EAAE;QAE/C,IAAI,gBAAgB,aAAa,OAAO,GAAG,GAAG;YAC5C,cAAc;YACd,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACvB,sBAAsB,aAAa,OAAO;gBAC1C,YAAY;gBACZ,QAAQ,aAAa,OAAO;gBAC5B,YAAY,aAAa,OAAO;YAClC;QACF,OAAO;YACL,cAAc;YACd,IAAI,YAAY,MAAM,CAAA,GAAA,wHAAA,CAAA,eAAY,AAAD,EAAE,WAAW;YAE9C,IAAI,CAAC,WAAW;gBACd,YAAY,MAAM,CAAA,GAAA,wHAAA,CAAA,kBAAe,AAAD,EAAE,WAAW;gBAC7C,IAAI,CAAC,WAAW;oBACd,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAqC,GAAG;wBAAE,QAAQ;oBAAI;gBAC1F;YACF;YAEA,MAAM,uBAAuB,KAAK,GAAG,CAAC,GAAG,oBAAoB,UAAU,WAAW;YAClF,MAAM,WAAW;YAEjB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACvB;gBACA,YAAY;gBACZ,OAAO,SAAS,KAAK;gBACrB,SAAS,SAAS,OAAO;gBACzB,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,UAAU,MAAM,CAAA,GAAA,+IAAA,CAAA,mBAAgB,AAAD;QAErC,IAAI,CAAC,SAAS,MAAM,OAAO;YACzB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,YAAY,QAAQ,IAAI,CAAC,KAAK;QACpC,MAAM,WAAW;QAEjB,cAAc;QACd,MAAM,eAAe,MAAM,CAAA,GAAA,wHAAA,CAAA,sBAAmB,AAAD,EAAE;QAE/C,IAAI,gBAAgB,aAAa,OAAO,GAAG,GAAG;YAC5C,YAAY;YACZ,MAAM,aAAa,aAAa,OAAO,GAAG;YAE1C,kCAAkC;YAClC,uBAAuB;YACvB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,sBAAsB;gBACtB,YAAY;YACd;QACF,OAAO;YACL,cAAc;YACd,IAAI,YAAY,MAAM,CAAA,GAAA,wHAAA,CAAA,eAAY,AAAD,EAAE,WAAW;YAE9C,IAAI,CAAC,WAAW;gBACd,YAAY,MAAM,CAAA,GAAA,wHAAA,CAAA,kBAAe,AAAD,EAAE,WAAW;gBAC7C,IAAI,CAAC,WAAW;oBACd,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;wBAAE,OAAO;oBAAqC,GAAG;wBAAE,QAAQ;oBAAI;gBAC1F;YACF;YAEA,aAAa;YACb,IAAI,UAAU,WAAW,IAAI,mBAAmB;gBAC9C,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAuB,GAAG;oBAAE,QAAQ;gBAAI;YAC5E;YAEA,SAAS;YACT,MAAM,WAAW,UAAU,WAAW,GAAG;YACzC,MAAM,UAAU,MAAM,CAAA,GAAA,wHAAA,CAAA,kBAAe,AAAD,EAAE,WAAW,UAAU;YAE3D,IAAI,CAAC,SAAS;gBACZ,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAA+B,GAAG;oBAAE,QAAQ;gBAAI;YACpF;YAEA,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,sBAAsB,KAAK,GAAG,CAAC,GAAG,oBAAoB;gBACtD,YAAY;YACd;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF","debugId":null}}]
}